@* Chat Popup Component - AI Agent Integrated *@
@using FWW.Site.UI.Services
@inject ChatService ChatService

<div class="chat-popup-container">
    @* Chat Toggle Button *@
    <button class="chat-toggle-btn @(isOpen ? "open" : "")" @onclick="ToggleChat" aria-label="Toggle chat">
        @if (isOpen)
        {
            <span class="material-symbols-outlined">close</span>
        }
        else
        {
            <span class="material-symbols-outlined">chat</span>
        }
    </button>

    @* Chat Window *@
    <div class="chat-window @(isOpen ? "open" : "")">
        @* Chat Header *@
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">
                    <span class="material-symbols-outlined">smart_toy</span>
                </div>
                <div class="chat-header-text">
                    <h3 class="chat-title">FOCUS Assistant</h3>
                    <span class="chat-status">
                        <span class="status-dot"></span>
                        Online
                    </span>
                </div>
            </div>
            <button class="chat-minimize-btn" @onclick="ToggleChat" aria-label="Close chat">
                <span class="material-symbols-outlined">remove</span>
            </button>
        </div>

        @* Chat Messages *@
        <div class="chat-messages" @ref="messagesContainer">
            @foreach (var message in messages)
            {
                <div class="chat-message @(message.IsUser ? "user" : "bot")">
                    @if (!message.IsUser)
                    {
                        <div class="message-avatar">
                            <span class="material-symbols-outlined">smart_toy</span>
                        </div>
                    }
                    <div class="message-bubble">
                        <p>@message.Text</p>
                        <span class="message-time">@message.Time.ToString("h:mm tt")</span>
                    </div>
                </div>
            }
            @if (isTyping)
            {
                <div class="chat-message bot">
                    <div class="message-avatar">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                    <div class="message-bubble typing">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* Chat Input *@
        <div class="chat-input-container">
            <input type="text" 
                   class="chat-input" 
                   placeholder="Type a message..." 
                   @bind="currentMessage"
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown"
                   disabled="@isTyping" />
            <button class="chat-send-btn" @onclick="SendMessage" disabled="@(isTyping || string.IsNullOrWhiteSpace(currentMessage))">
                <span class="material-symbols-outlined">send</span>
            </button>
        </div>
    </div>
</div>

@code {
    private bool isOpen = false;
    private bool isTyping = false;
    private string currentMessage = "";
    private List<ChatHistoryItem> messages = new();
    private ElementReference messagesContainer;

    protected override void OnInitialized()
    {
        // Add welcome message
        messages.Add(new ChatHistoryItem
        {
            Text = "Hi! I'm the FOCUS Assistant. How can I help you with your logistics needs today?",
            IsUser = false,
            Time = DateTime.Now
        });
    }

    private void ToggleChat()
    {
        isOpen = !isOpen;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(currentMessage) && !isTyping)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage) || isTyping) return;

        // Add user message
        var userMessage = new ChatHistoryItem
        {
            Text = currentMessage,
            IsUser = true,
            Time = DateTime.Now
        };
        messages.Add(userMessage);

        var userInput = currentMessage;
        currentMessage = "";
        StateHasChanged();

        // Show typing indicator
        isTyping = true;
        StateHasChanged();

        try
        {
            // Call AI chat service
            var response = await ChatService.SendMessageAsync(userInput, messages.Take(messages.Count - 1).ToList());

            // Add bot response
            messages.Add(new ChatHistoryItem
            {
                Text = response.Message,
                IsUser = false,
                Time = DateTime.Now
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chat error: {ex.Message}");
            messages.Add(new ChatHistoryItem
            {
                Text = "Sorry, I'm having trouble responding right now. Please try again.",
                IsUser = false,
                Time = DateTime.Now
            });
        }
        finally
        {
            isTyping = false;
            StateHasChanged();
        }
    }
}
