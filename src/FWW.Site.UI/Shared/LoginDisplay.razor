@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation

@if (isAuthenticated)
{
    <div class="user-menu">
        <span class="user-name">Hello, @userName</span>
        <a href="/.auth/logout?post_logout_redirect_uri=/" class="btn btn-light btn-rounded">
            <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 0.25rem;">logout</span>
            Logout
        </a>
    </div>
}
else
{
    <a href="/.auth/login/aad?post_login_redirect_uri=@Navigation.Uri" class="btn btn-light btn-rounded">
        <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 0.25rem;">login</span>
        Staff Login
    </a>
}

@code {
    private bool isAuthenticated = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthenticationState();
    }

    private async Task CheckAuthenticationState()
    {
        try
        {
            var response = await Http.GetAsync("/.auth/me");
            if (response.IsSuccessStatusCode)
            {
                var authData = await response.Content.ReadFromJsonAsync<AuthData>();
                if (authData?.ClientPrincipal != null)
                {
                    isAuthenticated = true;
                    userName = authData.ClientPrincipal.UserDetails ?? "User";
                }
            }
        }
        catch
        {
            isAuthenticated = false;
        }
    }

    private class AuthData { public ClientPrincipal? ClientPrincipal { get; set; } }
    private class ClientPrincipal { public string? UserDetails { get; set; } }
}
